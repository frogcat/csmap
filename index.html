<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>CSMap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-hash/leaflet-hash.js"></script>
  <style>
    .mix-blend-mode-multiply {
      mix-blend-mode: multiply;
    }
  </style>
</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
  <script>
    var pallet = new Uint32Array(0x200);
    for (var i = 0; i < 0x100; i++) pallet[i] = ((0xff - i) << 24) + 0x800020;
    for (var i = 0; i < 0x100; i++) pallet[i + 0x100] = (i << 24) + 0x00a5ff;

    function transform(data, unit) {
      var writer = new Uint32Array(data.buffer);
      var z = new Float32Array(0x10000);
      for (var i = 0; i < 0x10000; i++) {
        var h = (data[i * 4 + 0] << 16) + (data[i * 4 + 1] << 8) + data[i * 4 + 2];
        z[i] = h === 0x800000 ? NaN : (h > 0x800000 ? h - 0x1000000 : h) / 100 / unit;
      }

      for (var i = 0; i < 0x10000; i++) {
        if ((i & 0x3) !== 0) {
          writer[i] = writer[i - 1];
        } else if ((i & 0x300) !== 0) {
          writer[i] = writer[i - 0x100];
        } else {
          var c =
            (z[i + 0x101] + z[i + 0x102] + z[i + 0x201] + z[i + 0x202]) / 2 - (
              z[i + 1] + z[i + 2] + z[i + 0x301] + z[i + 0x302] +
              z[i + 0x100] + z[i + 0x103] + z[i + 0x200] + z[i + 0x203]) / 4;
          if (!isNaN(c)) {
            c = Math.max(-1, Math.min(1, c * 2));
            writer[i] = pallet[Math.floor((pallet.length - 1) * (c + 1) / 2)];
          } else {
            writer[i] = 0;
          }
        }
      }
    }

    var map = L.map("map", L.extend({
      minZoom: 0,
      maxZoom: 18,
      zoom: 8,
      center: [35.658342, 139.701462]
    }, L.Hash.parseHash(location.hash)));
    L.hash(map);
    map.zoomControl.setPosition("bottomright");
    map.attributionControl.addAttribution("<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>");

    var pale = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png", {
      minZoom: 2,
      maxNativeZoom: 16,
      maxZoom: 18,
      attribution: "淡色地図",
    }).addTo(map);
    var slope = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/slopemap/{z}/{x}/{y}.png", {
      minZoom: 2,
      maxNativeZoom: 16,
      maxZoom: 18,
      attribution: "傾斜量図",
      className: "mix-blend-mode-multiply"
    }).addTo(map);
    var curvature = L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png?nocache", {
      minZoom: 2,
      maxNativeZoom: 14,
      maxZoom: 18,
      crossOrigin: true,
      attribution: "標高タイル"
    }).on("tileload", function(event) {
      if (event.tile.done) return;
      event.tile.done = true;
      var canvas = document.createElement("canvas");
      canvas.width = 0x100, canvas.height = 0x100;
      var ctx = canvas.getContext("2d");
      ctx.drawImage(event.tile, 0, 0);
      var img = ctx.getImageData(0, 0, 0x100, 0x100);
      transform(img.data, 10 * Math.pow(2, 14 - Math.min(14, event.coords.z)));
      ctx.putImageData(img, 0, 0);
      event.tile.src = canvas.toDataURL();
      if (event.tile.parentNode && event.tile.parentNode.style.filter === "") {
        var blur = 3 * Math.pow(2, Math.max(0, event.coords.z - 14));
        event.tile.parentNode.style.filter = "blur(" + blur + "px)";
      }
    }).addTo(map);

    L.control.layers({}, {
      "淡色地図": pale,
      "Slope": slope,
      "Curvature": curvature
    }).addTo(map);
  </script>
</body>

</html>
